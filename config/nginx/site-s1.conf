

upstream php {	server unix:/var/run/php5-fpm.sock;}
upstream hhvm {	server unix:/var/run/hhvm/hhvm.sock;}
upstream monit {	server 127.0.0.1:9990; }

upstream ft_db {	server 127.0.0.1:6001; }
upstream sjcc_db {	server 127.0.0.1:6002; }

upstream ft_fsmaster {	server 127.0.0.1:9303; }
upstream ft_fsvol1 {	server 127.0.0.1:6101; }
upstream sjcc_fsmaster {	server 127.0.0.1:9304; }
upstream sjcc_fsvol1 {	server 127.0.0.1:6201; }

server {
	listen s1.ogg.ro:46500;

	root /home/www/s1/www_admin;
	index index.hh index.php index.html index.htm;
	server_name s1.ogg.ro;

	#-->Client: max size
	client_max_body_size 20M;

	#-->TESTING
	large_client_header_buffers 4 32k;


	access_log /var/log/nginx/s1.access.log;
	error_log  /var/log/nginx/s1.error.log;

	location / {	# include /etc/nginx/naxsi.rules # Uncomment to enable naxsi on this location
		# ACCESS
		auth_basic           "XXX";
    auth_basic_user_file /home/www/s1/codex;

		try_files $uri $uri/ =404;	#=404

		access_log /var/log/nginx/s1.access.log;
		error_log  /var/log/nginx/s1.error.log;

	}
	#--> CouchDB
	location ~ /ft_db/(.*)$ {
	    rewrite /ft_db/(.*) /$1 break;
	    proxy_pass http://ft_db;
	    add_header 'Access-Control-Allow-Origin' '*';
	    proxy_pass_header Accept;
	    proxy_pass_header Server;
      keepalive_requests 1000;
	    proxy_redirect off;
	    proxy_buffering off;
	    proxy_set_header Authorization ""; # $host;
	    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
	}
	location ~ /sjcc_db/(.*)$ {
	    rewrite /sjcc_db/(.*) /$1 break;
	    proxy_pass http://sjcc_db;
	    add_header 'Access-Control-Allow-Origin' '*';
	    proxy_pass_header Accept;
	    proxy_pass_header Server;
      keepalive_requests 1000;
	    proxy_redirect off;
	    proxy_buffering off;
	    proxy_set_header Host $host;
	    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
	}
	#-->WeedFS :: FT
	location ~ /ft_fs/(.*)$ {
			auth_basic "sff";
	    auth_basic_user_file /home/www/s1/vol1;
			rewrite /ft_fs/(.*) /$1 break;
			proxy_pass http://ft_fsmaster;
			proxy_set_header Host $host;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
	}
	location ~ /ft_vol1/(.*)$ {
	    auth_basic "sff";
	    auth_basic_user_file /home/www/s1/vol1;
			rewrite /ft_vol1/(.*) /$1 break;
			proxy_pass http://ft_fsvol1;
			proxy_set_header Host $host;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
	}
	#-->WeedFS :: SJCC
	location ~ /sjcc_fs/(.*)$ {
			auth_basic "sff";
	    auth_basic_user_file /home/www/s1/vol1;
			rewrite /sjcc_fs/(.*) /$1 break;
			proxy_pass http://sjcc_fsmaster;
			proxy_set_header Host $host;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
	}
	location ~ /sjcc_vol1/(.*)$ {
	    auth_basic "sff";
	    auth_basic_user_file /home/www/s1/vol1;
			rewrite /sjcc_vol1/(.*) /$1 break;
			proxy_pass http://sjcc_fsvol1;
			proxy_set_header Host $host;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
	}
	#--> Monit
	location ~ /monit/(.*)$ {
		rewrite /monit/(.*) /$1 break;
    proxy_ignore_client_abort on;
		proxy_pass http://monit;
		#proxy_set_header Host $host;
	}
	#--> HHVM & PHP5-FPM
	location ~* \.(hh|php)$ {
			# ACCESS
			auth_basic           "DEPRECATED. Go to new server";
	    auth_basic_user_file /home/www/s1/codex;

			# Fallback
			fastcgi_intercept_errors on;
			error_page 502 = @fpm;

			# Pass and try
			fastcgi_keep_conn on;
    	fastcgi_pass   hhvm;
	    fastcgi_index  index.hh;
   	  fastcgi_param  SCRIPT_FILENAME $document_root$fastcgi_script_name;
	    include        fastcgi_params;

			# Params
			fastcgi_param   PATH_INFO         $fastcgi_path_info;
	    fastcgi_param   SCRIPT_FILENAME 	$document_root$fastcgi_script_name;
	}

	#--> PHP FIRE
	location @fpm {
    # Pass
		fastcgi_split_path_info ^(.+\.php)(/.+)$; # ?? NOTE: You should have "cgi.fix_pathinfo = 0;" in php.ini
		fastcgi_pass unix:/var/run/php5-fpm.sock;
		include fastcgi_params;

		# PARAMETERS
		fastcgi_intercept_errors on;
		fastcgi_param   PATH_INFO         $fastcgi_path_info;
    fastcgi_param   SCRIPT_FILENAME   $document_root$fastcgi_script_name;
	}
	#--> Asset Management
	location ~ \.(js|css|png|jpg|jpeg|gif|ico|html|woff|ttf|svg|eot|otf|mp3|ogg)$ {
		    # ACCESS
				auth_basic           "DEPRECATED. Go to new server";
		    auth_basic_user_file /home/www/s1/codex;

		    # CONFIG
				expires 1M;
				access_log off;

				# HEADERS
				add_header Cache-Control "public";
				add_header "Access-Control-Allow-Origin" "*";
    }


	#############################
	#### ERROR HANDLING #########
	#############################
	error_page 404 /404.html;
	location /404.html {
		root /home/www/s1/error_page/404.html;
		internal;
	}
	error_page 500 502 503 504 /50x.html;
	location = /50x.html {
		root /home/www/s1/error_page/;
	}
	# deny access to .htaccess files, if Apache's document root
	# concurs with nginx's one
	location ~ /\.ht {
		deny all;
	}
}

